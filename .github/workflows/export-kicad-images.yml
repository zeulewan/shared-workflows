name: Export KiCad Images

on:
  workflow_call:

jobs:
  export:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Pull KiCad 9.0 Docker image
        run: |
          echo "Pulling KiCad 9.0 Docker image..."
          docker pull kicad/kicad:9.0

      - name: Set directory permissions
        run: |
          echo "Setting directory permissions to 777..."
          sudo chmod -R 777 .

      # Fetch official KiCad 3D models from GitLab
      - name: Clone KiCad 3D model library
        run: |
          git clone --depth 1 https://gitlab.com/kicad/libraries/kicad-packages3D.git kicad-packages3D

      # Install ImageMagick on the runner for cropping
      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      # Run KiCad Docker container to export files
      - name: Export schematic, PCB, 3D render, and STEP
        run: |
          echo "Exporting schematic, PCB, 3D renders, and 3D model..."
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            kicad/kicad:9.0 \
            bash -c "
              # Point both KiCad 8 and 9 3D env vars at the cloned library
              export KICAD8_3DMODEL_DIR=/workspace/kicad-packages3D
              export KICAD9_3DMODEL_DIR=/workspace/kicad-packages3D

              mkdir -p images

              # Export schematic
              kicad-cli sch export svg -o 'images/sch' kicad/*.kicad_sch
              mv images/sch/*.svg images/sch.svg
              rm -r images/sch

              # Export PCB front (2D)
              kicad-cli pcb export svg --mode-single \
                -o 'images/pcbf.svg' \
                --page-size-mode 2 \
                --exclude-drawing-sheet \
                --layers 'F.Cu,F.SilkS,F.Mask,Edge.Cuts' \
                kicad/*.kicad_pcb

              # Export PCB back (2D)
              kicad-cli pcb export svg --mode-single \
                -o 'images/pcbb.svg' \
                --page-size-mode 2 \
                -m \
                --exclude-drawing-sheet \
                --layers 'B.Cu,B.SilkS,B.Mask,Edge.Cuts' \
                kicad/*.kicad_pcb

              # Render PCB front (3D raytraced PNG, nicer lighting)
              kicad-cli pcb render \
                --output 'images/board.front.png' \
                --width 3000 \
                --height 3000 \
                --side top \
                --quality basic \
                --background transparent \
                kicad/*.kicad_pcb

              # Render PCB back (3D raytraced PNG, nicer lighting)
              kicad-cli pcb render \
                --output 'images/board.back.png' \
                --width 3000 \
                --height 3000 \
                --side bottom \
                --quality basic \
                --background transparent \
                kicad/*.kicad_pcb

              # Export high-detail 3D STEP model
              if ! kicad-cli pcb export step \
                --output 'images/board.step' \
                --force \
                --subst-models \
                kicad/*.kicad_pcb; then

                if [ -f 'images/board.step' ]; then
                  echo 'WARNING: kicad-cli pcb export step returned a non-zero exit code,'
                  echo 'but images/board.step was created. Continuing pipeline.'
                else
                  echo 'ERROR: STEP export failed and no images/board.step was created.'
                  exit 1
                fi
              fi
            "

      # Fix permissions after Docker creates files as root
      - name: Fix image permissions
        run: |
          sudo chown -R $(whoami):$(id -gn) images/

      # Crop the rendered 3D board images in-place using ImageMagick
      - name: Crop rendered board images
        run: |
          mogrify -trim +repage images/board.front.png
          mogrify -trim +repage images/board.back.png

      # Commit and push changes
      - name: Commit and push images
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          git add images/*
          git commit -m "Update KiCad images" || echo "No changes to commit."
          git push

      - name: Notify completion
        run: echo "Updated images and pushed changes to the repository."
